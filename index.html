<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Investment AI Viewer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #121212; 
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
      width: 200px;
      background: #1a1a1a;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.3s, transform 0.3s;
      z-index: 100;
    }
    
    .sidebar.collapsed {
      width: 50px;
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid #333;
      height: 50px;
    }
    
    .sidebar-title {
      font-size: 14px;
      font-weight: 700;
      color: #4a9eff;
      white-space: nowrap;
      overflow: hidden;
    }
    
    .sidebar.collapsed .sidebar-title { display: none; }
    
    .toggle-btn {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }
    .toggle-btn:hover { color: #fff; }
    
    .sidebar-menu {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      color: #aaa;
      font-size: 13px;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    
    .menu-item:hover { background: #252525; color: #fff; }
    .menu-item.active { background: #252525; color: #4a9eff; border-left-color: #4a9eff; }
    
    .menu-icon {
      width: 20px;
      text-align: center;
      margin-right: 12px;
      font-size: 16px;
    }
    
    .sidebar.collapsed .menu-text { display: none; }
    .sidebar.collapsed .menu-item { justify-content: center; padding: 12px; }
    .sidebar.collapsed .menu-icon { margin-right: 0; }
    
    .menu-badge {
      margin-left: auto;
      background: #4a9eff;
      color: #fff;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    .sidebar.collapsed .menu-badge { display: none; }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* æ¤œç´¢ãƒãƒ¼ */
    .search-bar {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: #1e1e1e;
      border-bottom: 1px solid #333;
      gap: 8px;
    }
    
    .search-bar input {
      flex: 1;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 4px;
      color: #fff;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
    }
    .search-bar input:focus { border-color: #4a9eff; }
    
    .search-btn {
      background: #4a9eff;
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .search-btn:hover { background: #3a8eef; }
    
    /* ã‚µãƒ–ãƒŠãƒ“ï¼ˆæ—¥ä»˜é¸æŠï¼‰ */
    .sub-nav {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      overflow-x: auto;
      background: #1a1a1a;
      border-bottom: 1px solid #333;
    }
    
    .date-chip {
      padding: 6px 14px;
      background: #2a2a2a;
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      color: #aaa;
      transition: all 0.2s;
    }
    .date-chip:hover { background: #3a3a3a; color: #fff; }
    .date-chip.active { background: #4a9eff; color: #fff; }
    
    .chip-badge {
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 3px;
      margin-left: 4px;
      font-weight: bold;
    }
    .chip-badge.daily { background: #2196f3; }
    .chip-badge.weekly { background: #ff9800; }
    
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
    .content-area {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    .content-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: #121212;
    }
    
    .empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      font-size: 14px;
      flex-direction: column;
      gap: 8px;
    }
    
    .hidden { display: none !important; }
    
    /* ãŠæ°—ã«å…¥ã‚Šãƒ“ãƒ¥ãƒ¼ */
    .favorites-view {
      padding: 16px;
      overflow-y: auto;
      height: 100%;
    }
    
    .fav-section {
      margin-bottom: 24px;
    }
    
    .fav-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #4a9eff;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }
    
    .fav-card {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .fav-card-content {
      flex: 1;
    }
    
    .fav-card-title {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    
    .fav-card-meta {
      font-size: 11px;
      color: #888;
    }
    
    .fav-star {
      color: #ffd700;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }
    .fav-star:hover { opacity: 0.7; }
    
    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        transform: translateX(-100%);
        width: 240px;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .sidebar.collapsed {
        width: 240px;
      }
      
      .mobile-header {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #1e1e1e;
        border-bottom: 1px solid #333;
      }
      
      .mobile-menu-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        padding: 4px 8px;
      }
      
      .mobile-title {
        flex: 1;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        color: #4a9eff;
      }
      
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 99;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-header { display: none; }
      .overlay { display: none !important; }
    }
  </style>
</head>
<body>
  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
  <div class="overlay hidden" id="overlay" onclick="closeSidebar()"></div>
  
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">ğŸ“Š Investment AI</span>
      <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
    </div>
    <nav class="sidebar-menu">
      <div class="menu-item active" data-view="research" onclick="switchView('research')">
        <span class="menu-icon">ğŸ“ˆ</span>
        <span class="menu-text">ãƒªã‚µãƒ¼ãƒ</span>
      </div>
      <div class="menu-item" data-view="news" onclick="switchView('news')">
        <span class="menu-icon">ğŸ“°</span>
        <span class="menu-text">ãƒ‹ãƒ¥ãƒ¼ã‚¹</span>
      </div>
      <div class="menu-item" data-view="performance" onclick="switchView('performance')">
        <span class="menu-icon">ğŸ“Š</span>
        <span class="menu-text">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</span>
      </div>
      <div class="menu-item" data-view="favorites" onclick="switchView('favorites')">
        <span class="menu-icon">â­</span>
        <span class="menu-text">ãŠæ°—ã«å…¥ã‚Š</span>
        <span class="menu-badge" id="fav-count">0</span>
      </div>
    </nav>
  </aside>
  
  <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
  <main class="main-area">
    <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="mobile-header">
      <button class="mobile-menu-btn" onclick="openSidebar()">â˜°</button>
      <span class="mobile-title" id="mobile-title">ãƒªã‚µãƒ¼ãƒ</span>
      <div style="width:32px"></div>
    </div>
    
    <!-- æ¤œç´¢ãƒãƒ¼ -->
    <div class="search-bar" id="searchBar">
      <input type="text" id="searchInput" placeholder="ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã¾ãŸã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..." onkeypress="if(event.key==='Enter')search()">
      <button class="search-btn" onclick="search()">æ¤œç´¢</button>
    </div>
    
    <!-- æ—¥ä»˜é¸æŠ -->
    <div class="sub-nav" id="dateNav"></div>
    
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="content-area">
      <!-- ãƒªã‚µãƒ¼ãƒ/ãƒ‹ãƒ¥ãƒ¼ã‚¹/ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¡¨ç¤ºç”¨iframe -->
      <iframe class="content-frame" id="contentFrame"></iframe>
      
      <!-- ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤º -->
      <div class="favorites-view hidden" id="favoritesView">
        <div class="fav-section">
          <div class="fav-section-title">ğŸ“ˆ ãƒªã‚µãƒ¼ãƒ</div>
          <div id="favResearchList"></div>
        </div>
        <div class="fav-section">
          <div class="fav-section-title">ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
          <div id="favNewsList"></div>
        </div>
      </div>
      
      <!-- ç©ºçŠ¶æ…‹ -->
      <div class="empty-state hidden" id="emptyState">
        <span style="font-size:32px">ğŸ“­</span>
        <span>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</span>
      </div>
    </div>
  </main>

  <script>
    // ==========================================
    // è¨­å®š
    // ==========================================
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbygeU1cHx94ol2KY7w8BRgBVgALjFbEFFHRQXJe1DxXrbu_6Z7dtNfHkQJoLY9keGDn/exec'; // ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«è¨­å®š
    
    let currentView = 'research';
    let archiveData = { research: [], news: [], performance: [] };
    let favorites = { research: [], news: [] };
    
    // ==========================================
    // åˆæœŸåŒ–
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
      loadArchiveData();
      loadFavorites();
    });
    
    // ==========================================
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼
    // ==========================================
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    }
    
    function openSidebar() {
      document.getElementById('sidebar').classList.add('open');
      document.getElementById('overlay').classList.remove('hidden');
    }
    
    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('overlay').classList.add('hidden');
    }
    
    // ==========================================
    // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    // ==========================================
    function switchView(view) {
      currentView = view;
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === view);
      });
      
      // ãƒ¢ãƒã‚¤ãƒ«ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
      const titles = { research: 'ãƒªã‚µãƒ¼ãƒ', news: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', performance: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹', favorites: 'ãŠæ°—ã«å…¥ã‚Š' };
      document.getElementById('mobile-title').textContent = titles[view];
      
      // ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‰ã˜ã‚‹ï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰
      closeSidebar();
      
      // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      const frame = document.getElementById('contentFrame');
      const favView = document.getElementById('favoritesView');
      const searchBar = document.getElementById('searchBar');
      const dateNav = document.getElementById('dateNav');
      
      if (view === 'favorites') {
        frame.classList.add('hidden');
        favView.classList.remove('hidden');
        searchBar.classList.add('hidden');
        dateNav.classList.add('hidden');
        renderFavorites();
      } else {
        frame.classList.remove('hidden');
        favView.classList.add('hidden');
        searchBar.classList.remove('hidden');
        dateNav.classList.remove('hidden');
        updateDateNav();
      }
    }
    
    // ==========================================
    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    // ==========================================
    async function loadArchiveData() {
      try {
        const response = await fetch(`${GAS_URL}?action=getArchive`);
        const data = await response.json();
        archiveData = data;
        updateDateNav();
      } catch (e) {
        console.error('Archive load error:', e);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰
      }
    }
    
    // ==========================================
    // æ—¥ä»˜ãƒŠãƒ“æ›´æ–°
    // ==========================================
    function updateDateNav() {
      const nav = document.getElementById('dateNav');
      const data = archiveData[currentView] || [];
      
      if (data.length === 0) {
        nav.innerHTML = '<span style="color:#666;font-size:12px">ãƒ‡ãƒ¼ã‚¿ãªã—</span>';
        return;
      }
      
      nav.innerHTML = data.map((item, idx) => {
        const date = new Date(item.date);
        const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
        const isWeekly = item.type === 'weekly';
        const badge = isWeekly ? '<span class="chip-badge weekly">W</span>' : '<span class="chip-badge daily">D</span>';
        return `<div class="date-chip ${idx===0?'active':''}" onclick="selectDate(${idx})">${dateStr}${badge}</div>`;
      }).join('');
      
      if (data.length > 0) selectDate(0);
    }
    
    function selectDate(idx) {
      document.querySelectorAll('.date-chip').forEach((chip, i) => {
        chip.classList.toggle('active', i === idx);
      });
      
      const data = archiveData[currentView] || [];
      if (data[idx]) {
        loadContent(data[idx].content);
      }
    }
    
    function loadContent(html) {
      const frame = document.getElementById('contentFrame');
      const doc = frame.contentDocument || frame.contentWindow.document;
      
      // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ãŸHTML
      const enhancedHtml = addFavoriteButtons(html);
      
      doc.open();
      doc.write(enhancedHtml);
      doc.close();
    }
    
    // ==========================================
    // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³è¿½åŠ 
    // ==========================================
    function addFavoriteButtons(html) {
      // stock-cardã«â˜†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      const starBtn = `<button class="fav-btn" onclick="parent.toggleFavorite(this)" data-type="${currentView}">â˜†</button>`;
      const style = `
        <style>
          .fav-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
            z-index: 10;
          }
          .fav-btn:hover { color: #ffd700; }
          .fav-btn.active { color: #ffd700; }
          .stock-card, .topic-block { position: relative; }
        </style>
      `;
      
      // ã‚«ãƒ¼ãƒ‰ã«ãƒœã‚¿ãƒ³è¿½åŠ 
      let enhanced = html.replace(/<div class="stock-card"/g, `<div class="stock-card">${starBtn}`);
      enhanced = enhanced.replace(/<div class="topic-block">/g, `<div class="topic-block">${starBtn.replace('research', 'news')}`);
      
      // ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
      enhanced = enhanced.replace('</head>', style + '</head>');
      
      return enhanced;
    }
    
    // ==========================================
    // ãŠæ°—ã«å…¥ã‚Šç®¡ç†
    // ==========================================
    function loadFavorites() {
      const saved = localStorage.getItem('investmentAI_favorites');
      if (saved) {
        favorites = JSON.parse(saved);
        updateFavCount();
      }
    }
    
    function saveFavorites() {
      localStorage.setItem('investmentAI_favorites', JSON.stringify(favorites));
      updateFavCount();
    }
    
    function updateFavCount() {
      const total = (favorites.research?.length || 0) + (favorites.news?.length || 0);
      document.getElementById('fav-count').textContent = total;
    }
    
    function toggleFavorite(btn) {
      const type = btn.dataset.type;
      const card = btn.closest('.stock-card, .topic-block');
      const id = card?.id || card?.querySelector('.ticker')?.textContent || Date.now().toString();
      const title = card?.querySelector('.card-title, .topic-title')?.textContent?.substring(0, 50) || 'Unknown';
      
      if (!favorites[type]) favorites[type] = [];
      
      const idx = favorites[type].findIndex(f => f.id === id);
      if (idx >= 0) {
        favorites[type].splice(idx, 1);
        btn.classList.remove('active');
        btn.textContent = 'â˜†';
      } else {
        favorites[type].push({ id, title, date: new Date().toISOString() });
        btn.classList.add('active');
        btn.textContent = 'â˜…';
      }
      
      saveFavorites();
    }
    
    function renderFavorites() {
      const researchList = document.getElementById('favResearchList');
      const newsList = document.getElementById('favNewsList');
      
      researchList.innerHTML = (favorites.research || []).length === 0 
        ? '<div style="color:#666;font-size:12px;padding:8px">ãŠæ°—ã«å…¥ã‚Šãªã—</div>'
        : favorites.research.map(f => `
          <div class="fav-card">
            <div class="fav-card-content">
              <div class="fav-card-title">${escapeHtml(f.title)}</div>
              <div class="fav-card-meta">${new Date(f.date).toLocaleDateString('ja-JP')}</div>
            </div>
            <span class="fav-star" onclick="removeFavorite('research','${f.id}')">â˜…</span>
          </div>
        `).join('');
      
      newsList.innerHTML = (favorites.news || []).length === 0
        ? '<div style="color:#666;font-size:12px;padding:8px">ãŠæ°—ã«å…¥ã‚Šãªã—</div>'
        : favorites.news.map(f => `
          <div class="fav-card">
            <div class="fav-card-content">
              <div class="fav-card-title">${escapeHtml(f.title)}</div>
              <div class="fav-card-meta">${new Date(f.date).toLocaleDateString('ja-JP')}</div>
            </div>
            <span class="fav-star" onclick="removeFavorite('news','${f.id}')">â˜…</span>
          </div>
        `).join('');
    }
    
    function removeFavorite(type, id) {
      if (!favorites[type]) return;
      favorites[type] = favorites[type].filter(f => f.id !== id);
      saveFavorites();
      renderFavorites();
    }
    
    // ==========================================
    // æ¤œç´¢
    // ==========================================
    function search() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      
      const frame = document.getElementById('contentFrame');
      const doc = frame.contentDocument || frame.contentWindow.document;
      
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
      const highlights = doc.querySelectorAll('.search-highlight');
      highlights.forEach(el => {
        el.outerHTML = el.textContent;
      });
      
      // æ¤œç´¢ï¼†ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT);
      const matches = [];
      while (walker.nextNode()) {
        if (walker.currentNode.textContent.toLowerCase().includes(query.toLowerCase())) {
          matches.push(walker.currentNode);
        }
      }
      
      matches.forEach(node => {
        const span = doc.createElement('span');
        span.innerHTML = node.textContent.replace(
          new RegExp(`(${query})`, 'gi'),
          '<mark class="search-highlight" style="background:#ffd700;color:#000;padding:0 2px;">$1</mark>'
        );
        node.parentNode.replaceChild(span, node);
      });
      
      // æœ€åˆã®ãƒãƒƒãƒã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      const first = doc.querySelector('.search-highlight');
      if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // ==========================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ==========================================
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>
